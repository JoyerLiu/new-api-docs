# 倍率设置

倍率设置是 NewAPI 计费系统的核心配置，通过设置不同的倍率可以灵活控制各种模型和用户组的计费标准。

## 倍率系统概述

NewAPI 使用三层倍率体系来计算用户的配额消耗：

1. 模型倍率（ModelRatio） - 定义不同AI模型的基础计费倍数
2. 补全倍率（CompletionRatio） - 对输出token进行额外计费调整
3. 分组倍率（GroupRatio） - 为不同用户组设置差异化计费倍数

### 配额与倍率的关系

在 New API 系统中，倍率是计算配额消耗的关键参数。配额是系统内部的计费单位，所有的API调用最终都会转换为配额点数进行扣减。

配额单位转换：  

- 1 美元 = 500,000 配额点数
- 配额点数是系统内部计费的基础单位
- 用户的余额、消费记录都以配额点数为准

### 配额计算公式

#### 按量计费模型（基于Token消耗）

```
配额消耗 = (输入token数 + 输出token数 × 补全倍率) × 模型倍率 × 分组倍率
```

#### 按次计费模型（固定价格）

```
配额消耗 = 模型固定价格 × 分组倍率 × 配额单位(500,000)
```

#### 音频模型（特殊处理，new-api内部自动处理）

```
配额消耗 = (文本输入token + 文本输出token × 补全倍率 + 音频输入token × 音频倍率 + 音频输出token × 音频倍率 × 音频补全倍率) × 模型倍率 × 分组倍率
```

#### 预消费与后消费机制

New API 采用预消费和后消费的双重计费机制：

1. **预消费阶段**：API调用前，根据预估token数计算配额消耗并预扣
2. **后消费阶段**：API调用完成后，根据实际token数重新计算配额消耗
3. **差额调整**：如果实际消耗与预消费不同，系统会自动调整用户配额余额

```
预消费配额 = 预估token数 × 模型倍率 × 分组倍率
实际配额 = 实际token数 × 模型倍率 × 分组倍率
配额调整 = 实际配额 - 预消费配额
```

## 模型倍率设置

模型倍率定义了不同AI模型的基础计费倍数，系统为各种模型预设了默认倍率。

### 常见模型倍率示例

| 模型名称 | 模型倍率 | 补全倍率 | 官网价格（输入） | 官网价格（输出） |
|---------|---------|---------|---------|---------|
| gpt-4o | 1.25 | 4 | $2.5/1M Tokens | $10/1M Tokens |
| gpt-3.5-turbo | 0.25 | 1.33 | $0.5/1M Tokens | $1.5/1M Tokens |
| gpt-4o-mini | 0.075 | 4 | $0.15/1M Tokens | $0.6/1M Tokens |
| o1 | 7.5 | 4 | $15/1M Tokens | $60/1M Tokens |

倍率含义说明：

- 模型倍率：相对于基础计费单位的倍数，反映模型的成本差异
- 补全倍率：输出token相对于输入token的计费倍数，反映输出成本差异
- 倍率越高，消耗的配额越多；倍率越低，消耗的配额越少

### 设置方法

1. JSON格式设置：直接编辑模型倍率JSON配置
2. 可视化编辑器：通过图形界面设置倍率

![倍率1](../../../assets/guide/rate-setting-1.png)

## 补全倍率设置

补全倍率用于对输出token进行额外计费，主要用于平衡不同模型的输入输出成本差异。

### 默认补全倍率

| 模型类型 | 官网价格（输入） | 官网价格（输出） | 补全倍率 | 说明 |
|---------|---------|------|------|------|
| gpt-4o | 2.5$/1M Tokens | 10$/1M Tokens | 4 | 输出是输入的4倍 |
| gpt-3.5-turbo | 0.5$/1M Tokens | 1$/1M Tokens | 2 | 输出是输入的2倍 |
| gpt-image-1 | 5$/1M Tokens | 40$/1M Tokens | 8 | 输出是输入的8倍 |
| gpt-4o-mini | 0.15$/1M Tokens | 0.6$/1M Tokens | 4 | 输出是输入的4倍 |
| 其他模型 | 1 | 1 | 1 | 输出是输入的1倍 |

### 设置说明

- 补全倍率主要影响输出token的计费
- 设置为1表示输出token计费与输入token计费相同
- 大于1表示输出token计费更高，小于1表示输出token计费更低

## 分组倍率设置

分组倍率允许为不同用户组设置差异化的计费倍数，实现灵活的定价策略。

### 分组倍率配置

```json
{
  "vip": 0.5,
  "premium": 0.8,
  "standard": 1.0,
  "trial": 2.0
}
```

### 分组倍率优先级

1. 用户专属倍率：为特定用户设置的个人倍率
2. 分组倍率：用户所属分组的倍率
3. 默认倍率：系统默认倍率（通常为1.0）

![倍率2](../../../assets/guide/rate-setting-2.png)

## 可视化倍率设置

可视化编辑器提供了直观的倍率管理界面，支持：

- 批量编辑模型倍率
- 实时预览倍率配置
- 冲突检测和提示
- 一键同步上游倍率

![倍率3](../../../assets/guide/rate-setting-3.png)

## 未设置倍率模型

对于未设置倍率的模型，系统会：

1. 自用模式：使用默认倍率37.5
2. 商业模式：提示"倍率或价格未配置"错误
3. 自动检测：在管理界面显示未配置的模型

![倍率4](../../../assets/guide/rate-setting-4.png)

## 上游倍率同步

系统支持从上游渠道自动同步倍率设置：

- 自动获取上游模型倍率
- 批量更新本地倍率配置
- 保持与上游价格同步
- 支持手动调整和覆盖

![倍率5](../../../assets/guide/rate-setting-5.png)

## 常见问题

### Q: 如何为新模型设置倍率？

A: 可以通过可视化编辑器添加新模型，或直接在JSON配置中添加。建议先设置保守倍率，根据实际使用情况调整。

### Q: 分组倍率如何生效？

A: 分组倍率会与模型倍率相乘，最终影响用户的配额消耗计算。用户的实际倍率 = 模型倍率 × 分组倍率。

### Q: 补全倍率的作用是什么？

A: 补全倍率主要用于平衡输入输出token的成本差异。某些模型的输出成本远高于输入成本，需要通过补全倍率进行调整。

### Q: 如何批量设置相似模型的倍率？

A: 可以通过可视化编辑器进行批量操作，或者直接在JSON配置中批量添加相似模型的倍率设置。

## 配额计算实例

### 示例1：GPT-4 标准用户对话

场景参数：

- 输入token：1,000
- 输出token：500
- 模型倍率：15
- 补全倍率：2
- 分组倍率：1.0（标准用户）

计算过程：

```
配额消耗 = (1,000 + 500 × 2) × 15 × 1.0
         = (1,000 + 1,000) × 15
         = 2,000 × 15
         = 30,000 配额点数
```

等价美元成本：30,000 ÷ 500,000 = $0.06

### 示例2：GPT-3.5 VIP用户对话

场景参数：

- 输入token：2,000
- 输出token：1,000
- 模型倍率：0.25
- 补全倍率：1.33
- 分组倍率：0.5（VIP用户50%折扣）

计算过程：

```
配额消耗 = (2,000 + 1,000 × 1.33) × 0.25 × 0.5
         = (2,000 + 1,330) × 0.125
         = 3,330 × 0.125
         = 416.25 配额点数
```

等价美元成本：416.25 ÷ 500,000 = $0.00083

### 示例3：按次计费模型（如Midjourney）

场景参数：

- 模型固定价格：$0.02
- 分组倍率：1.0（标准用户）
- 配额单位：500,000

计算过程：

```
配额消耗 = 0.02 × 1.0 × 500,000
         = 10,000 配额点数
```

等价美元成本：10,000 ÷ 500,000 = $0.02

有关更多计费规则，请查看[常见问题](../support/faq.md)
