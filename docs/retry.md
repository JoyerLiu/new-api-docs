# �� 重试机制

## 💫 功能概述

重试机制可以在请求失败时自动尝试其他渠道，提高系统的可用性和稳定性。

### 工作原理

```mermaid
flowchart TD
    A[请求开始] --> B{请求是否成功?}
    B -->|成功| C[返回结果]
    B -->|失败| D{是否可重试?}
    D -->|是| E[选择下一个渠道]
    E --> F[重试请求]
    F --> B
    D -->|否| G[返回错误]
```

### 重试策略
1. 第一次重试：使用同优先级的其他渠道
2. 第二次重试：尝试下一优先级的渠道
3. 以此类推，直到达到最大重试次数

## ⚙️ 配置说明

### 基础配置

在`设置 -> 运营设置 -> 通用设置`中配置：

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| 重试次数 | 单次请求最大重试次数 | 3 |
| 重试间隔 | 重试之间的等待时间(秒) | 1 |
| 错误阈值 | 触发重试的错误次数 | 5 |

## 💾 缓存配置

!!! tip "性能优化"
    强烈建议开启缓存功能以提升重试性能

### Redis缓存（推荐）

```bash
# Redis连接配置
REDIS_CONN_STRING=redis://default:password@localhost:6379

# Redis缓存配置
REDIS_CACHE_TTL=3600  # 缓存过期时间(秒)
REDIS_MAX_RETRIES=3   # 最大重试次数
```

### 内存缓存

如果无法使用Redis，可以启用内存缓存：

```bash
# 启用内存缓存
MEMORY_CACHE_ENABLED=true

# 内存缓存配置
MEMORY_CACHE_SIZE=1000  # 最大缓存条目数
MEMORY_CACHE_TTL=3600   # 缓存过期时间(秒)
```

## 🎯 错误处理

### 默认错误处理

以下错误码默认不会触发重试：
- `400`: 请求参数错误
- `504`: 网关超时
- `524`: 服务器超时

### 自定义错误处理

可以在渠道配置中自定义错误处理规则：

=== "状态码复写"
    ```json
    {
      "400": "500",  // 将400错误转为500以触发重试
      "429": "503"   // 将限流错误转为503
    }
    ```

=== "错误匹配"
    ```json
    {
      "error_patterns": [
        "rate_limit_exceeded",
        "connection_error"
      ]
    }
    ```

## 📊 监控指标

### 重试统计
- 重试次数
- 重试成功率
- 平均重试耗时
- 渠道可用性

### 告警配置
```yaml
alerts:
  retry_rate:
    threshold: 0.1  # 重试率阈值
    window: 5m     # 统计窗口
  error_rate:
    threshold: 0.05 # 错误率阈值
    window: 1h     # 统计窗口
```

## 🔍 故障排查

### 常见问题

1. 重试频繁
   - 检查网络连接
   - 验证渠道配置
   - 调整重试阈值

2. 缓存异常
   - 确认Redis连接
   - 检查内存使用
   - 清理过期缓存

3. 性能问题
   - 优化缓存配置
   - 调整重试间隔
   - 增加可用渠道

### 日志分析

```bash
# 查看重试相关日志
grep "retry" /path/to/app.log

# 分析重试统计
grep "retry_stats" /path/to/app.log | jq .
```

## 💡 最佳实践

1. 合理配置重试参数
   - 设置适当的重试次数
   - 避免过于频繁的重试
   - 使用递增的重试间隔

2. 优化缓存策略
   - 使用Redis缓存
   - 设置合理的TTL
   - 定期清理过期数据

3. 监控和告警
   - 配置重试率告警
   - 监控渠道可用性
   - 定期分析重试日志

4. 错误处理
   - 区分临时和永久错误
   - 自定义错误处理规则
   - 记录详细错误信息 